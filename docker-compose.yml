services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: hotel
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d:ro
      - ./migrations:/app/migrations:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  adminer:
    image: adminer:4
    ports:
      - "8089:8080"
    depends_on:
      - postgres

  auth-service:
    build:
      context: .
      dockerfile: build/auth/Dockerfile
    environment:
      HTTP_PORT: ":8080"
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/hotel?sslmode=disable
      JWT_SECRET: super-secret
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8080:8080"

  hotel-service:
    build:
      context: .
      dockerfile: build/hotel/Dockerfile
    environment:
      HTTP_PORT: ":8081"
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/hotel?sslmode=disable
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8081:8081"

  booking-service:
    build:
      context: .
      dockerfile: build/booking/Dockerfile
    environment:
      HTTP_PORT: ":8082"
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/hotel?sslmode=disable
      PAYMENT_SERVICE_URL: http://payment-service:8083
      NOTIFICATION_SERVICE_URL: http://notification-service:8085
    depends_on:
      postgres:
        condition: service_healthy
      payment-service:
        condition: service_started
      notification-service:
        condition: service_started
    ports:
      - "8082:8082"

  payment-service:
    build:
      context: .
      dockerfile: build/payment/Dockerfile
    environment:
      HTTP_PORT: ":8083"
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/hotel?sslmode=disable
      PAYMENT_PROVIDER_KEY: sandbox-key
      BOOKING_SERVICE_URL: http://booking-service:8082
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8083:8083"

  notification-service:
    build:
      context: .
      dockerfile: build/notification/Dockerfile
    environment:
      HTTP_PORT: ":8085"
    ports:
      - "8085:8085"

  api-gateway:
    build:
      context: .
      dockerfile: build/gateway/Dockerfile
    environment:
      HTTP_PORT: ":8088"
      JWT_SECRET: super-secret
      BOOKING_SERVICE_URL: http://booking-service:8082
      PAYMENT_SERVICE_URL: http://payment-service:8083
      AGGREGATE_TARGET_URL: http://hotel-service:8081
      GATEWAY_MODE: proxy_all
      GATEWAY_ROUTES_FILE: config/routes.yml
      HEALTH_INTERVAL: 10s
      UPSTREAM_TIMEOUT: 5s
      UPSTREAM_RETRIES: 2
      CIRCUIT_BREAKER_WINDOW: 30s
      CIRCUIT_BREAKER_THRESHOLD: 0.5
      CIRCUIT_BREAKER_COOLDOWN: 15s
    depends_on:
      - booking-service
      - payment-service
      - hotel-service
    ports:
      - "8088:8088"

  swagger-ui:
    image: swaggerapi/swagger-ui
    ports:
      - "8087:8080"
    environment:
      SWAGGER_JSON: /app/swagger.yaml
    volumes:
      - ./docs/swagger/swagger.yaml:/app/swagger.yaml:ro
    depends_on:
      - api-gateway
      
volumes:
  pgdata: {}
